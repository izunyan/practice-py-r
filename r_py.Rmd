---
title: "r with py"
author: ""
date: "`r format(Sys.time(), '%Y/%m/%d')`"
output:
  html_document: 
    toc: TRUE
    toc_float: true
    toc_depth: 4
    number_sections: true
    # theme: readable
    # highlight: pygments
    css: custom.css
editor_options: 
  chunk_output_type: console
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)


# tibbleの表示行数指定
tibble_opt <- list(
  "tibble.print_min" = 5 #, # 表示する行の数
  # "tibble.width" = 65     # 横の表示幅
)

options(tibble_opt)

```

# Pythonインストール時
* `Add Python 3.x to PATH`にチェックを入れる
  + https://www.python.jp/install/windows/install.html

# パッケージの管理（pip関連）
* 以下，コマンドプロンプトから実行
  + Windowsでは，「ここに入力して検索」にcmdを入れて検索
* インストール済みパッケージの確認
  + `pip list`
* パッケージインストール
  + `pip install {ここにパッケージ名}`
* アップデートが必要なパッケージ一覧
  + `pip list -o`  
* パッケージのアップデート
  + `pip install -U {ここにパッケージ名}`

<!-- * アップデートが必要なパッケージインストール -->
<!--   + pip install （どこからか忘れた…要確認） -->


# コマンドプロンプトの操作

* ルートに移動
  + `cd \`
* ディレクトリに移動しカレントに
  + `cd ここにパス`
* フォルダ作成
  + `mkdir フォルダ名`
* 構造図式化
  + `tree`

# 仮想環境:venv

* 以下，コマンドプロンプトから実行
* 作成
  + `python -m venv パス名\myenv(名前は任意)`
  + 該当フォルダがすでにカレントになっていればmyenvだけでOK
* 仮想環境に入る
  + `myenv\Scripts\activate`
* 仮想環境から出る
  + `deactivate`





# Rとpythonの対応

## RとPythonでデータフレームのやり取り

* 緑チャンクがpython

```{r }
library(reticulate)

df <- 
  palmerpenguins::penguins

```

```{python class.source="bg-success"}
r.df.head()

df_py = r.df[['species',	'bill_length_mm']]

```

```{r }
head(py$df_py)
```


## ここまで作ったオブジェクトの整理
### Rのデータフレーム名変更
```{r}
pen_r <- df
rm(df) # df削除
```

### pythonのオブジェクト削除
```{python}
del df_py
```

## Pythonでもペンギン

-   ペンギンデータ for python
    -   https://pypi.org/project/palmerpenguins/

```{python class.source="bg-success"}
from palmerpenguins import load_penguins
pen_p = load_penguins()
 
pen_p
```


## 列を選ぶ
### R
```{r}
library(tidyverse)


names(pen_r)

pen_r |> 
  select(species, bill_length_mm)

pen_r |> 
  select(species:bill_length_mm)
```

### Python
```{python class.source="bg-success"}
pen_p.info()

pen_p[['species', 'bill_length_mm']]

pen_p.loc[:, 'species':'bill_length_mm']

```

## 列名を変更する
### R

* new = old

```{r}
pen_r |> 
  rename(species2 = species,
         island2  = island)
```

### Python

* 'old':'new'

```{python class.source="bg-success"}
pen_p.rename(columns = {'species':'species2',
                        'island':'island2'})

```

## 行を選ぶ
### R

```{r}
pen_r |> 
  filter(bill_length_mm > 55)

pen_r |> 
  filter(bill_length_mm > 55 & bill_depth_mm == 17)
```

### Python
```{python class.source="bg-success"}
pen_p[pen_p['bill_length_mm'] > 55]
pen_p.query('bill_length_mm > 55 & bill_depth_mm == 17')

```

## 新たな列を作る
### R

```{r}
pen_r |> 
  mutate(species2 = species,
         island2 = island) 

# 列を選択してから
pen_r |> 
  select(species) |> 
  mutate(species2 = species) 
```



### Python
```{python class.source="bg-success"}
pen_p.assign(species2 = pen_p['species'],
              island2 = pen_p['island'])

# 列を選択してから

pen_p[['species']].assign(species2 = pen_p['species'])  

```

## 要約値作成
### 変数1つのみ
#### R
```{r}
pen_r |> 
  summarise(blm_mean = mean(bill_length_mm, 
                            na.rm = TRUE),
            blm_sd   = sd(bill_length_mm, 
                            na.rm = TRUE),
            blm_n    = sum(!is.na(bill_length_mm)))
```

#### Python

* 欠損値は自動で削除して計算されている

```{python class.source="bg-success"}
pen_p.bill_length_mm.mean()
pen_p.bill_length_mm.std()
pen_p.bill_length_mm.count()
```

* [pandas.DataFrame.aggregate](https://pandas.pydata.org/docs/reference/api/pandas.DataFrame.aggregate.html#)
* 短縮して`agg`で実行できる

```{python}
pen_p.bill_length_mm.agg(['mean', 'std', 'count'])
```

### 変数複数
#### R
```{r}
pen_r |> 
  summarise(across(c(bill_length_mm, bill_depth_mm),
                   list(mean = ~mean(., na.rm = TRUE),
                          sd =   ~sd(., na.rm = TRUE),
                           n =  ~sum(!is.na(.)))))
```

#### Python

```{python class.source="bg-success"}
pen_p.agg({'bill_length_mm' : ['mean', 'std', 'count'],
            'bill_depth_mm' : ['mean', 'std', 'count']})

```

* 先に列選択すれば関数繰り返さなくてもよい

```{rpython class.source="bg-success"}
pen_p[['bill_length_mm', 'bill_depth_mm']].agg(['mean', 'std', 'count'])
```


### グループごとに集計 
#### R
```{r}
pen_r |> 
  group_by(species) |> 
  summarise(mean_blm = mean(bill_length_mm, 
                            na.rm = TRUE))
```

#### Python
```{python class.source="bg-success"}
pen_p.groupby('species').bill_length_mm.agg('mean')

```

 
### データフレーム全体
#### R
```{r}
pen_r |> 
  summarise(across(where(is.numeric),
    mean, na.rm = TRUE))
```

#### Python


```{python class.source="bg-success"}
pen_p.agg('mean')
```


## データフレーム作成
### R
```{r}
df_r_a <- 
 tribble(
    ~id, ~x1, ~x2,
    1,  10,  50,
    2,  20,  60,
    3,  30,  70
  )

df_r_b <- 
  tribble(
    ~id, ~x1, ~x3,
    1,  10,  80,
    2,  20,  90,
    4,  40, 100
  )

df_r_a
df_r_b
```



### Python
```{python class.source="bg-success"}
import pandas as pd
df_py_a = pd.DataFrame([[1,10,50], 
                        [2,20,60], 
                        [3,30,70]],
              columns = ['id','x1','x2'])

df_py_b = pd.DataFrame([[1,10,80], 
                        [2,20,90], 
                        [4,40,100]],
              columns = ['id','x1','x3'])


df_py_a
df_py_b

# または

pd.DataFrame({'id':[1,2,3],
              'x1':[10,20,30], 
              'x2':[50,60,70]})


```

## キー変数を元にデータフレームを横に連結

* [dplyr::join](https://dplyr.tidyverse.org/reference/mutate-joins.html)
* [pandas.merge](https://pandas.pydata.org/docs/reference/api/pandas.merge.html#)

### 左に連結
#### R
```{r}
df_r_a |> 
  left_join(df_r_b, by = "id")
```

#### Python
```{python class.source="bg-success"}
pd.merge(df_py_a, df_py_b, on = 'id', how = 'left')
```


### すべて連結
#### R
```{r}
df_r_a |> 
  full_join(df_r_b)
```

#### Python
```{python class.source="bg-success"}
pd.merge(df_py_a, df_py_b, how = 'outer')
```

### 共通するデータの連結
#### R
```{r}
df_r_a |> 
  inner_join(df_r_b)
```

#### Python
```{python class.source="bg-success"}
pd.merge(df_py_a, df_py_b, how = 'inner')
```

## 縦に連結
### R
```{r}

```

### Python
```{python class.source="bg-success"}

```

## データフレームの縦横構造の変換
### R
```{r}

```

### Python
```{python class.source="bg-success"}

```

## 
### R
```{r}

```

### Python
```{python class.source="bg-success"}

```
